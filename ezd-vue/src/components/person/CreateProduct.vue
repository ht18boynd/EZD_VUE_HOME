<template>
  <div>
    <start-header></start-header>
    <div class="cs-height_100 cs-height_lg_70"></div>

    <div class="container">
      <div class="cs-cover_photo cs-bg" data-src="assets/img/cover-photo.jpeg">
        <button class="cs-edit_cover cs-center">
          <svg
            width="33"
            height="33"
            viewBox="0 0 33 33"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M29.9062 24.75H26.8125V21.6562C26.8125 21.3827 26.7039 21.1204 26.5105 20.927C26.3171 20.7336 26.0548 20.625 25.7812 20.625C25.5077 20.625 25.2454 20.7336 25.052 20.927C24.8586 21.1204 24.75 21.3827 24.75 21.6562V24.75H21.6562C21.3827 24.75 21.1204 24.8586 20.927 25.052C20.7336 25.2454 20.625 25.5077 20.625 25.7812C20.625 26.0548 20.7336 26.3171 20.927 26.5105C21.1204 26.7039 21.3827 26.8125 21.6562 26.8125H24.75V29.9062C24.75 30.1798 24.8586 30.4421 25.052 30.6355C25.2454 30.8289 25.5077 30.9375 25.7812 30.9375C26.0548 30.9375 26.3171 30.8289 26.5105 30.6355C26.7039 30.4421 26.8125 30.1798 26.8125 29.9062V26.8125H29.9062C30.1798 26.8125 30.4421 26.7039 30.6355 26.5105C30.8289 26.3171 30.9375 26.0548 30.9375 25.7812C30.9375 25.5077 30.8289 25.2454 30.6355 25.052C30.4421 24.8586 30.1798 24.75 29.9062 24.75Z"
              fill="url(#paint0_linear_1353_5467)"
            />
            <path
              d="M17.5312 24.75H5.15625C4.88275 24.75 4.62044 24.6414 4.42705 24.448C4.23365 24.2546 4.125 23.9923 4.125 23.7188V5.15625C4.125 4.88275 4.23365 4.62044 4.42705 4.42705C4.62044 4.23365 4.88275 4.125 5.15625 4.125H23.7188C23.9923 4.125 24.2546 4.23365 24.448 4.42705C24.6414 4.62044 24.75 4.88275 24.75 5.15625V17.5312C24.75 17.8048 24.8586 18.0671 25.052 18.2605C25.2454 18.4539 25.5077 18.5625 25.7812 18.5625C26.0548 18.5625 26.3171 18.4539 26.5105 18.2605C26.7039 18.0671 26.8125 17.8048 26.8125 17.5312V5.15625C26.8125 4.33574 26.4866 3.54883 25.9064 2.96864C25.3262 2.38845 24.5393 2.0625 23.7188 2.0625H5.15625C4.33574 2.0625 3.54883 2.38845 2.96864 2.96864C2.38845 3.54883 2.0625 4.33574 2.0625 5.15625V23.7188C2.0625 24.5393 2.38845 25.3262 2.96864 25.9064C3.54883 26.4866 4.33574 26.8125 5.15625 26.8125H17.5312C17.8048 26.8125 18.0671 26.7039 18.2605 26.5105C18.4539 26.3171 18.5625 26.0548 18.5625 25.7812C18.5625 25.5077 18.4539 25.2454 18.2605 25.052C18.0671 24.8586 17.8048 24.75 17.5312 24.75Z"
              fill="url(#paint1_linear_1353_5467)"
            />
            <path
              d="M11.3438 11.3438C12.7676 11.3438 13.9219 10.1895 13.9219 8.76562C13.9219 7.34177 12.7676 6.1875 11.3438 6.1875C9.91989 6.1875 8.76562 7.34177 8.76562 8.76562C8.76562 10.1895 9.91989 11.3438 11.3438 11.3438Z"
              fill="url(#paint2_linear_1353_5467)"
            />
            <path
              d="M7.51781 14.7367L6.1875 16.0773V22.6876H22.6875V16.0773L18.2634 11.6429C18.1676 11.5463 18.0535 11.4696 17.9278 11.4172C17.8022 11.3648 17.6674 11.3379 17.5312 11.3379C17.3951 11.3379 17.2603 11.3648 17.1347 11.4172C17.009 11.4696 16.8949 11.5463 16.7991 11.6429L11.3438 17.1086L8.98219 14.7367C8.88632 14.64 8.77226 14.5633 8.64659 14.511C8.52093 14.4586 8.38614 14.4316 8.25 14.4316C8.11386 14.4316 7.97907 14.4586 7.85341 14.511C7.72774 14.5633 7.61368 14.64 7.51781 14.7367Z"
              fill="url(#paint3_linear_1353_5467)"
            />
            <defs>
              <linearGradient
                id="paint0_linear_1353_5467"
                x1="20.625"
                y1="20.625"
                x2="32.9893"
                y2="26.8849"
                gradientUnits="userSpaceOnUse"
              >
                <stop offset="0" stop-color="#FC466B" />
                <stop offset="1" stop-color="#3F5EFB" />
              </linearGradient>
              <linearGradient
                id="paint1_linear_1353_5467"
                x1="2.0625"
                y1="2.0625"
                x2="31.7368"
                y2="17.0862"
                gradientUnits="userSpaceOnUse"
              >
                <stop offset="0" stop-color="#FC466B" />
                <stop offset="1" stop-color="#3F5EFB" />
              </linearGradient>
              <linearGradient
                id="paint2_linear_1353_5467"
                x1="8.76562"
                y1="6.1875"
                x2="14.9478"
                y2="9.31744"
                gradientUnits="userSpaceOnUse"
              >
                <stop offset="0" stop-color="#FC466B" />
                <stop offset="1" stop-color="#3F5EFB" />
              </linearGradient>
              <linearGradient
                id="paint3_linear_1353_5467"
                x1="6.1875"
                y1="11.3379"
                x2="22.3081"
                y2="23.2031"
                gradientUnits="userSpaceOnUse"
              >
                <stop offset="0" stop-color="#FC466B" />
                <stop offset="1" stop-color="#3F5EFB" />
              </linearGradient>
            </defs>
          </svg>
        </button>
      </div>
      <div class="cs-prifile_wrap">
        <profileLeftVue></profileLeftVue>

        <div class="cs-profile_right">
          <div class="cs-height_30 cs-height_lg_30"></div>
          <h2 class="cs-section_heading cs-style1">Create</h2>
          <div class="cs-height_25 cs-height_lg_25"></div>
          <form
            class="row"
            @submit.prevent="submitProduct"
            enctype="multipart/form-data"
          >
            <div class="col-lg-12">
              <div class="cs-file_wrap">
                <div class="cs-file_in">
                  <svg
                    width="46"
                    height="47"
                    viewBox="0 0 46 47"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M44.125 36.5H39.25V31.625C39.25 31.194 39.0788 30.7807 38.774 30.476C38.4693 30.1712 38.056 30 37.625 30C37.194 30 36.7807 30.1712 36.476 30.476C36.1712 30.7807 36 31.194 36 31.625V36.5H31.125C30.694 36.5 30.2807 36.6712 29.976 36.976C29.6712 37.2807 29.5 37.694 29.5 38.125C29.5 38.556 29.6712 38.9693 29.976 39.274C30.2807 39.5788 30.694 39.75 31.125 39.75H36V44.625C36 45.056 36.1712 45.4693 36.476 45.774C36.7807 46.0788 37.194 46.25 37.625 46.25C38.056 46.25 38.4693 46.0788 38.774 45.774C39.0788 45.4693 39.25 45.056 39.25 44.625V39.75H44.125C44.556 39.75 44.9693 39.5788 45.274 39.274C45.5788 38.9693 45.75 38.556 45.75 38.125C45.75 37.694 45.5788 37.2807 45.274 36.976C44.9693 36.6712 44.556 36.5 44.125 36.5Z"
                      fill="#737A99"
                    />
                    <path
                      d="M24.625 36.5H5.125C4.69402 36.5 4.2807 36.3288 3.97595 36.024C3.67121 35.7193 3.5 35.306 3.5 34.875V5.625C3.5 5.19402 3.67121 4.7807 3.97595 4.47595C4.2807 4.17121 4.69402 4 5.125 4H34.375C34.806 4 35.2193 4.17121 35.524 4.47595C35.8288 4.7807 36 5.19402 36 5.625V25.125C36 25.556 36.1712 25.9693 36.476 26.274C36.7807 26.5788 37.194 26.75 37.625 26.75C38.056 26.75 38.4693 26.5788 38.774 26.274C39.0788 25.9693 39.25 25.556 39.25 25.125V5.625C39.25 4.33207 38.7364 3.09209 37.8221 2.17785C36.9079 1.26361 35.6679 0.75 34.375 0.75H5.125C3.83207 0.75 2.59209 1.26361 1.67785 2.17785C0.763615 3.09209 0.25 4.33207 0.25 5.625V34.875C0.25 36.1679 0.763615 37.4079 1.67785 38.3221C2.59209 39.2364 3.83207 39.75 5.125 39.75H24.625C25.056 39.75 25.4693 39.5788 25.774 39.274C26.0788 38.9693 26.25 38.556 26.25 38.125C26.25 37.694 26.0788 37.2807 25.774 36.976C25.4693 36.6712 25.056 36.5 24.625 36.5Z"
                      fill="#737A99"
                    />
                    <path
                      d="M14.875 15.375C17.1187 15.375 18.9375 13.5562 18.9375 11.3125C18.9375 9.06884 17.1187 7.25 14.875 7.25C12.6313 7.25 10.8125 9.06884 10.8125 11.3125C10.8125 13.5562 12.6313 15.375 14.875 15.375Z"
                      fill="#737A99"
                    />
                    <path
                      d="M8.84625 20.7209L6.75 22.8334V33.2497H32.75V22.8334L25.7787 15.8459C25.6277 15.6936 25.448 15.5727 25.2499 15.4902C25.0519 15.4077 24.8395 15.3652 24.625 15.3652C24.4105 15.3652 24.1981 15.4077 24.0001 15.4902C23.802 15.5727 23.6223 15.6936 23.4713 15.8459L14.875 24.4584L11.1537 20.7209C11.0027 20.5686 10.823 20.4477 10.6249 20.3652C10.4269 20.2827 10.2145 20.2402 10 20.2402C9.78548 20.2402 9.57308 20.2827 9.37506 20.3652C9.17704 20.4477 8.99731 20.5686 8.84625 20.7209Z"
                      fill="#737A99"
                    />
                  </svg>
                  <h3>Drag and drop an image or <span>Upload</span></h3>
                  <p>high resulation image (jpeg, png, svg)</p>
                </div>
                <div class="cs-close_file" title="Close">
                  <svg
                    width="33"
                    height="33"
                    viewBox="0 0 33 33"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <rect
                      x="0.421875"
                      y="0.163086"
                      width="32"
                      height="32"
                      rx="16"
                      fill="url(#paint0_linear_1353_4256)"
                    />
                    <path
                      d="M22.129 11.8702C22.5195 11.4797 22.5195 10.8465 22.129 10.456C21.7385 10.0655 21.1053 10.0655 20.7148 10.456L22.129 11.8702ZM10.7148 20.456C10.3242 20.8465 10.3242 21.4797 10.7148 21.8702C11.1053 22.2607 11.7385 22.2607 12.129 21.8702L10.7148 20.456ZM12.129 10.456C11.7385 10.0655 11.1053 10.0655 10.7148 10.456C10.3242 10.8465 10.3242 11.4797 10.7148 11.8702L12.129 10.456ZM20.7148 21.8702C21.1053 22.2607 21.7385 22.2607 22.129 21.8702C22.5195 21.4797 22.5195 20.8465 22.129 20.456L20.7148 21.8702ZM20.7148 10.456L10.7148 20.456L12.129 21.8702L22.129 11.8702L20.7148 10.456ZM10.7148 11.8702L20.7148 21.8702L22.129 20.456L12.129 10.456L10.7148 11.8702Z"
                      fill="white"
                    />
                    <defs>
                      <linearGradient
                        id="paint0_linear_1353_4256"
                        x1="0.421875"
                        y1="0.163086"
                        x2="38.7886"
                        y2="19.5877"
                        gradientUnits="userSpaceOnUse"
                      >
                        <stop offset="0" stop-color="#FC466B" />
                        <stop offset="1" stop-color="#3F5EFB" />
                      </linearGradient>
                    </defs>
                  </svg>
                </div>
                <input
                  type="file"
                  class="cs-file"
                  @change="handleImageChange"
                />

                <img
                  id="previewImage"
                  class="img-fluid"
                  v-if="imagePreviewUrl"
                  :src="imagePreviewUrl"
                  alt="Preview"
                  style="width: 360px; height: 240px"
                />
              </div>
              <div class="cs-height_25 cs-height_lg_25"></div>
            </div>
            <div class="col-lg-6">
              <div class="cs-form_field_wrap">
                <!-- Use v-model to bind the selected game to a data property -->
                <label class="cs-form_label">Select Game</label>
                <select
                  class="cs-form_field"
                  v-model="gameProductId"
                  @change="onGameSelectionChange"
                >
                  <option disabled>Lựa Chọn Dưới Đây...</option>
                  <option
                    v-for="game in gamelist"
                    :key="game.id"
                    :value="game.id"
                  >
                    {{ game.nameGame }}
                  </option>
                </select>
              </div>
              <div class="cs-height_20 cs-height_lg_20"></div>
              <div class="row">
                <div class="col-6">
                  <div class="cs-form_field_wrap">
                    <label class="cs-form_label">Price/hour:</label>
                    <input
                      type="text"
                      class="cs-form_field"
                      v-model="formattedItemPrice"
                      @input="updateItemPrice"
                      placeholder="Price"
                    />
                  </div>
                </div>

                <div class="col-6">
                  <div class="cs-form_field_wrap">
                    <label class="cs-form_label">Hour:</label>
                    <input
                      type="number"
                      class="cs-form_field"
                      v-model="hour"
                      placeholder="Price per Hour"
                    />
                  </div>
                </div>
              </div>

              <div class="cs-height_20 cs-height_lg_20"></div>
              <div class="cs-form_field_wrap">
                <textarea
                  cols="30"
                  rows="5"
                  placeholder="e. g.  description"
                  class="cs-form_field"
                  v-model="description"
                ></textarea>
              </div>

              <div class="cs-height_20 cs-height_lg_20"></div>
            </div>
            <div class="col-lg-6">
              <div class="cs-form_field_wrap">
                <label class="cs-form_label">Role:</label>
                <select class="cs-form_field" v-model="roleProductId">
                  <!-- Use v-for to loop through the gamelist and display options -->
                  <option disabled>Lựa Chọn Dưới Đây...</option>

                  <option
                    v-for="role in selectedGameDetails.roles"
                    :key="role.id"
                    :value="role.id"
                  >
                    {{ role.name }}
                    <!-- Assuming each game object has a 'name' property -->
                  </option>
                </select>
              </div>
              <div class="cs-height_20 cs-height_lg_20"></div>
              <div class="cs-form_field_wrap">
                <label class="cs-form_label">Level:</label>
                <select class="cs-form_field" v-model="levelProductId">
                  <!-- Use v-for to loop through the gamelist and display options -->
                  <option disabled>Lựa Chọn Dưới Đây...</option>

                  <option
                    v-for="level in selectedGameDetails.levels"
                    :key="level.id"
                    :value="level.id"
                  >
                    {{ level.name }}
                    <!-- Assuming each game object has a 'name' property -->
                  </option>
                </select>
              </div>
              <div class="cs-height_20 cs-height_lg_20"></div>

              <div class="cs-form_field_wrap">
                <label class="cs-form_label">Gender :</label>
                <select class="cs-form_field" v-model="genderProductId">
                  <!-- Use v-for to loop through the gamelist and display options -->
                  <option disabled>Lựa Chọn Dưới Đây...</option>

                  <option
                    v-for="gender in selectedGameDetails.genders"
                    :key="gender.id"
                    :value="gender.id"
                  >
                    {{ gender.name }}
                    <!-- Assuming each game object has a 'name' property -->
                  </option>
                </select>
              </div>
              <div class="cs-height_20 cs-height_lg_20"></div>
              <button class="cs-btn cs-style1 cs-btn_lg" type="submit">
                <span>Submit Item</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="cs-height_100 cs-height_lg_70"></div>

    <footerHome></footerHome>
  </div>
</template>

<script>
import "vue-awesome-paginate/dist/style.css";
import { userInfo } from "@/store";
import footerHome from "@/pages/footer.vue";
import startHeader from "@/pages/startHeader.vue";
import Swal from "sweetalert2";
import GameService from "@/service/GameService";
import ProductService from "@/service/ProductService";
import profileLeftVue from "@/pages/profileLeft.vue";

export default {
  name: "createProduct",
  data() {
    return {
      user: "",
      price: 0, // Giá trị thực
      formattedItemPrice: "", // Giá trị đã định dạng
      hour: 0,
      imgProduct: null, // Array to store selected image files
      imagePreviewUrl: null, // Preview of the selected image
      gameProductId: "",
      description: "",
      genderProductId: "",
      levelProductId: "",
      roleProductId: "",
      gamelist: [],
      BASE_URL: process.env.BASE_URL,
      selectedGameDetails: {
        roles: [],
        levels: [],
        genders: [],
      },
    };
  },

  components: {
    startHeader,
    footerHome,
    profileLeftVue,
  },
  methods: {
    async onGameSelectionChange() {
      try {
        // Gọi phương thức để lấy thông tin chi tiết của trò chơi
        const gameDetails = await GameService.getGameById(this.gameProductId);

        console.log(gameDetails);
        // Cập nhật chi tiết trò chơi đã chọn, roles, levels, và genders
        this.selectedGameDetails = gameDetails;
        this.roles = gameDetails.roles;
        this.levels = gameDetails.levels;
        this.genders = gameDetails.genders;
      } catch (error) {
        console.error("Error updating game details:", error);
      }
    },

    updateItemPrice() {
      // Kiểm tra xem formattedItemPrice có phải là một chuỗi hay không
      if (typeof this.formattedItemPrice === "string") {
        // Loại bỏ dấu phẩy và chuyển đổi về số
        const numericValue = Number(
          this.formattedItemPrice.replace(/[^0-9]/g, ""),
        );
        // Kiểm tra xem numericValue có phải là một số hợp lệ hay không
        if (!isNaN(numericValue)) {
          // Cập nhật giá trị thực
          this.price = numericValue;
        } else {
          console.error("Giá trị không hợp lệ:", numericValue);
        }
      } else {
        console.error(
          "formattedItemPrice không phải là chuỗi:",
          this.formattedItemPrice,
        );
      }
    },

    handleImageChange(event) {
      // Handle image selection and preview
      this.imgProduct = event.target.files[0];

      // Tạo một đối tượng FileReader để đọc hình ảnh
      let reader = new FileReader();

      reader.onload = (e) => {
        this.imagePreviewUrl = e.target.result; // Cập nhật imagePreviewUrl với dữ liệu hình ảnh
      };

      // Đọc hình ảnh được chọn
      reader.readAsDataURL(this.imgProduct);
    },

    async submitProduct() {
  const userProductId = userInfo.value.id;

  // Check for empty fields
  if (
    !userProductId ||
    !this.gameProductId ||
    !this.price ||
    !this.imgProduct ||
    !this.description ||
    !this.hour ||
    !this.roleProductId ||
    !this.levelProductId ||
    !this.genderProductId
  ) {
    // Display error message for empty fields
    Swal.fire("", "Please fill in all fields", "error");
    return; // Stop further execution
  }

  try {
     await ProductService.saveProduct(
      userProductId,
      this.gameProductId,
      this.roleProductId,
      this.levelProductId,
      this.genderProductId,
      this.imgProduct,
      this.price,
      this.hour,
      this.description
    );

    Swal.fire("", "Tạo Mới Thành Công ✔️", "success");

    // Reset form values to default after successful submission
    this.gameProductId = "";
    this.roleProductId = "";
    this.levelProductId = "";
    this.genderProductId = "";
    this.imgProduct = null;
    this.price = 0;
    this.formattedItemPrice="";
    this.hour = 0;
    this.description = "";
  } catch (error) {
    Swal.fire("", "Đã Có Lỗi Xảy Ra !", "error");
  }
},

    async getAllGames() {
      try {
        const response = await GameService.getAllGames();
        this.gamelist = response.data.sort((a, b) => b.id - a.id);
        console.log(this.gamelist);
      } catch (error) {
        console.error("Lỗi khi lấy danh sách trò chơi: ", error);
      }
    },
  },

  async created() {
    this.getAllGames();
  },
  watch: {
    // Theo dõi thay đổi giá trị thực để cập nhật giá trị đã định dạng
    itemPrice: function (newVal) {
      this.formattedItemPrice = newVal.toLocaleString("vi-VN", {
        style: "currency",
        currency: "VND",
      });
    },
  },
};
</script>

<style scoped>
.cs-form_label {
  color: wheat;
}
</style>
